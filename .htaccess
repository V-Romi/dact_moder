# .htaccess - Headers de Seguridad para DAClimaTECH
# Coloca este archivo en la raíz de tu sitio web

# =====================================
# CONTENT SECURITY POLICY (CSP)
# =====================================

# CSP Principal - Política estricta pero funcional
Header always set Content-Security-Policy "\
    default-src 'self'; \
    script-src 'self' 'unsafe-inline' 'unsafe-eval' \
        https://www.googletagmanager.com \
        https://www.google-analytics.com \
        https://cdnjs.cloudflare.com \
        https://fonts.googleapis.com; \
    style-src 'self' 'unsafe-inline' \
        https://fonts.googleapis.com \
        https://fonts.gstatic.com; \
    img-src 'self' data: \
        https://www.google-analytics.com \
        https://*.google-analytics.com \
        https://maps.googleapis.com \
        https://maps.gstatic.com; \
    font-src 'self' \
        https://fonts.gstatic.com \
        https://fonts.googleapis.com; \
    connect-src 'self' \
        https://www.google-analytics.com \
        https://*.google-analytics.com \
        https://api.whatsapp.com; \
    frame-src 'self' \
        https://www.google.com \
        https://maps.google.com; \
    object-src 'none'; \
    base-uri 'self'; \
    form-action 'self' \
        https://wa.me; \
    upgrade-insecure-requests; \
    block-all-mixed-content"

# CSP de respaldo para navegadores que no soportan la versión completa
Header always set Content-Security-Policy-Report-Only "\
    default-src 'self'; \
    report-uri /csp-report"

# =====================================
# HEADERS DE SEGURIDAD PRINCIPALES  
# =====================================

# Prevenir ataques de clickjacking
Header always set X-Frame-Options "SAMEORIGIN"

# Prevenir sniffing de tipo MIME
Header always set X-Content-Type-Options "nosniff"

# Habilitar protección XSS del navegador
Header always set X-XSS-Protection "1; mode=block"

# Forzar HTTPS (HSTS) - 1 año
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Política de referrer - balance entre privacidad y funcionalidad
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Política de permisos - Controlar APIs del navegador
Header always set Permissions-Policy "\
    geolocation=(), \
    microphone=(), \
    camera=(), \
    magnetometer=(), \
    gyroscope=(), \
    speaker=(), \
    vibrate=(), \
    fullscreen=(self), \
    payment=()"

# =====================================
# HEADERS DE RENDIMIENTO Y CACHÉ
# =====================================

# Cache HTML por poco tiempo
<FilesMatch "\.(html|htm)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>

# Cache CSS y JS por 30 días
<FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=2592000"
    Header unset Pragma
    Header unset Expires
</FilesMatch>

# Cache imágenes por 1 año
<FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header unset Pragma
    Header unset Expires
</FilesMatch>

# Cache fuentes por 1 año
<FilesMatch "\.(woff|woff2|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header unset Pragma
    Header unset Expires
</FilesMatch>

# Service Worker - Sin caché
<Files "service-worker.js">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
    Header set Service-Worker-Allowed "/"
</Files>

# =====================================
# PROTECCIÓN DE ARCHIVOS SENSIBLES
# =====================================

# Denegar acceso a archivos de configuración
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|config)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Proteger archivos de desarrollo
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# =====================================
# COMPRESIÓN GZIP
# =====================================

<IfModule mod_deflate.c>
    # Comprimir HTML, CSS, JavaScript, Text, XML y fuentes
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    
    # Remover ETag para archivos comprimidos
    <FilesMatch "\.(js|css|xml|gz|html|htm)$">
        FileETag None
    </FilesMatch>
</IfModule>

# =====================================
# REDIRECTS HTTPS
# =====================================

# Forzar HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirigir www a no-www (ajustar según tu preferencia)
RewriteCond %{HTTP_HOST} ^www\.daclimatech\.com [NC]
RewriteRule ^(.*)$ https://daclimatech.com/$1 [L,R=301]

# =====================================
# CONFIGURACIÓN DE ERRORES PERSONALIZADOS
# =====================================

# Páginas de error personalizadas
ErrorDocument 404 /404.html
ErrorDocument 403 /403.html
ErrorDocument 500 /500.html

# =====================================
# CORS (Cross-Origin Resource Sharing)
# =====================================

# Permitir CORS para fuentes
<FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css)$">
    Header set Access-Control-Allow-Origin "*"
</FilesMatch>

# =====================================
# BLOQUEOS DE SEGURIDAD ADICIONALES
# =====================================

# Bloquear bots maliciosos conocidos
<RequireAll>
    Require all granted
    Require not env bad-bot
</RequireAll>

SetEnvIfNoCase User-Agent "BadBot|MalwareBot|Spam" bad-bot

# Limitar métodos HTTP
<RequireAll>
    Require method GET POST HEAD
</RequireAll>

# =====================================
# CONFIGURACIÓN DE MIME TYPES
# =====================================

# Asegurar MIME types correctos
AddType application/javascript .js
AddType text/css .css
AddType image/webp .webp
AddType application/font-woff2 .woff2
AddType application/manifest+json .webmanifest

# =====================================
# LOGS DE SEGURIDAD (Opcional)
# =====================================

# Crear log personalizado para eventos de seguridad (comentado por defecto)
# CustomLog logs/security.log combined env=suspicious

# Detectar actividad sospechosa
# SetEnvIf Request_URI "\.\./\.\." suspicious
# SetEnvIf Request_URI "\/proc\/self\/environ" suspicious
# SetEnvIf Request_URI "\/etc\/passwd" suspicious